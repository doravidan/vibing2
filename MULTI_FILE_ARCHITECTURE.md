# QuickVibe 2.0 - Multi-File Project Architecture

## Overview

QuickVibe 2.0 has been redesigned from a single-file HTML generator to a full multi-file project management system with PFC (Prompt Caching) optimization.

## Architecture Changes

### 1. Database Schema

**New Model: `ProjectFile`**
```prisma
model ProjectFile {
  id        String   @id @default(cuid())
  projectId String
  path      String   // e.g., "src/index.html", "src/styles/main.css"
  content   String
  language  String   // e.g., "html", "css", "javascript"
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, path])
  @@index([projectId])
}
```

- `Project.currentCode` is deprecated but kept for backward compatibility
- Each project now has multiple `ProjectFile` records
- Files are tracked individually with paths like `src/index.html`, `src/styles/main.css`

### 2. PFC-Optimized System Prompt

**Location**: `lib/pfc-system-prompt.ts`

Key features:
- Static instructions at beginning for better caching
- File operation commands using XML-style markers
- Incremental development workflow
- Search/replace updates instead of full file rewrites
- Consistent formatting for cache hits

**File Operation Format**:
```xml
<FILE_CREATE>
<path>src/components/Button.tsx</path>
<language>typescript</language>
<content>
// Code here
</content>
</FILE_CREATE>

<FILE_UPDATE>
<path>src/App.tsx</path>
<language>typescript</language>
<operation>replace</operation>
<search><!-- exact content to find --></search>
<replace><!-- new content --></replace>
</FILE_UPDATE>

<FILE_DELETE>
<path>src/old-file.js</path>
</FILE_DELETE>
```

### 3. File Management System

**Location**: `lib/file-manager.ts`

**Core Functions**:
- `getProjectFiles(projectId)` - Get all files
- `getFile(projectId, path)` - Get single file
- `createFile(projectId, path, content, language)` - Create new file
- `updateFile(projectId, path, content)` - Update entire file
- `updateFileWithReplace(projectId, path, search, replace)` - Precise updates
- `deleteFile(projectId, path)` - Delete file
- `applyFileOperations(projectId, operations[])` - Batch operations
- `buildFileTree(files)` - Build tree structure for UI
- `generatePreview(files)` - Combine files into HTML preview

### 4. Workflow

#### First User Prompt (Project Initialization):
1. AI creates project structure:
   - `src/index.html` - Main HTML
   - `src/styles/main.css` - Styles
   - `src/scripts/app.js` - JavaScript
2. Files saved to database via `ProjectFile` model
3. Preview generated by combining all files

#### Subsequent Prompts (Feature Addition):
1. AI analyzes existing files (via context)
2. AI identifies files to modify/create
3. AI uses FILE_UPDATE with search/replace for precise changes
4. Only changed files are updated in database
5. Preview regenerated with updated files

**Example Flow**:
```
User: "Create a todo app"
→ AI creates: index.html, styles/main.css, scripts/app.js

User: "Add ability to mark todos as complete"
→ AI updates: scripts/app.js (adds toggleComplete function)
→ AI updates: styles/main.css (adds .completed class)
→ Files updated in database, preview refreshed

User: "Add localStorage persistence"
→ AI creates: scripts/storage.js
→ AI updates: scripts/app.js (imports storage functions)
→ New file created, existing file updated, preview refreshed
```

### 5. PFC Benefits

**Cache-Friendly Patterns**:
1. **Static System Prompt**: Core instructions never change → high cache hit rate
2. **Incremental Updates**: Only changed portions sent → reduced token usage
3. **File References**: Reference files by path instead of repeating content
4. **Consistent Format**: XML markers always structured the same way

**Token Savings**:
- First prompt: ~2000 tokens (system prompt cached)
- Second prompt: ~500 tokens (reuses cached system prompt + only shows changes)
- Third prompt: ~400 tokens (reuses everything + minimal new content)

### 6. UI Components Needed

**File Tree Component** (`components/FileTree.tsx`):
- Displays folder/file structure
- Click to view file
- Visual indicators for modified files

**Code Editor Component** (`components/CodeEditor.tsx`):
- Monaco Editor or similar
- Syntax highlighting by language
- Read-only (AI controls edits)
- Show diff view for changes

**File Tabs Component** (`components/FileTabs.tsx`):
- Open multiple files in tabs
- Active file highlighted
- Quick file switching

### 7. API Updates Needed

**`/api/agent/stream/route.ts`**:
1. Import PFC system prompt
2. Replace old system prompt with `getPFCSystemPrompt()`
3. Add file operation extraction from AI response
4. Apply file operations to database
5. Stream file changes to frontend

**`/api/projects/save/route.ts`**:
1. Save files using `ProjectFile` model
2. Keep backward compatibility with `currentCode`

**`/api/projects/load/route.ts`**:
1. Load files from `ProjectFile` model
2. Fall back to `currentCode` for old projects

### 8. Frontend Updates Needed

**`app/create/page.tsx`**:
1. Replace iframe preview with split view:
   - Left: File tree + Code editor
   - Right: Live preview (iframe)
2. Track project files state
3. Handle file operation updates from AI
4. Show file changes as they happen

### 9. Migration Strategy

**Backward Compatibility**:
- Old projects with `currentCode` still work
- First edit converts to file-based system
- `currentCode` → `src/index.html` automatic migration

**New Projects**:
- Start with file-based system from first prompt
- No `currentCode` field used

### 10. Benefits Summary

✅ **Multi-file projects**: Proper separation of HTML/CSS/JS
✅ **Incremental updates**: Only change what's needed
✅ **PFC optimization**: Massive token savings on subsequent prompts
✅ **Better UX**: See actual project structure
✅ **Scalability**: Can handle large projects with many files
✅ **Version control ready**: Easy to export to Git
✅ **Collaboration**: Multiple devs can see file changes clearly

### 11. Testing Plan

1. Create new project → Verify files created
2. Add feature → Verify only changed files updated
3. Delete file → Verify file removed
4. Preview generation → Verify HTML/CSS/JS combined correctly
5. PFC metrics → Verify token savings on prompts 2, 3, 4+
6. Old project → Verify backward compatibility

### 12. Performance Considerations

- File count limit: 100 files per project (reasonable for web apps)
- File size limit: 50KB per file (warn if larger)
- Preview generation: Cache last preview, regenerate only on changes
- Database: Index on `projectId` and `projectId_path`

### 13. Future Enhancements

- Export project as ZIP
- GitHub integration (push to repo)
- Template projects (start from React/Vue/etc template)
- File search across project
- Multi-file editing (bulk find/replace)
- Branching (save different versions)

## Implementation Status

✅ Database schema updated (ProjectFile model)
✅ Migration created and applied
✅ PFC system prompt created
✅ File manager utilities created
⏳ API updates needed
⏳ Frontend updates needed
⏳ Testing needed

## Next Steps

1. Update `/api/agent/stream/route.ts` to use new system prompt
2. Update frontend to handle file-based projects
3. Create file tree and code editor components
4. Test end-to-end workflow
5. Measure PFC token savings
